<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Banco Virtual</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../shared/css/global.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark admin-navbar fixed-top">
        <div class="container-fluid">
            <button class="btn btn-link text-white d-lg-none" id="sidebarToggle">
                <i class="bi bi-list fs-4"></i>
            </button>
            <a class="navbar-brand" href="dashboard.html">
                <i class="bi bi-bank2 me-2"></i>Banco Virtual
            </a>
            <div class="ms-auto d-flex align-items-center">
                <span class="text-white me-3">
                    <i class="bi bi-person-circle me-1"></i>
                    <span id="adminName">Administrador</span>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="cerrarSesion()">
                    <i class="bi bi-box-arrow-right me-1"></i>Salir
                </button>
            </div>
        </div>
    </nav>

    <div class="d-flex" style="margin-top: 56px;">
        <!-- Sidebar -->
        <nav class="admin-sidebar" id="sidebar">
            <ul class="nav flex-column py-3">
                <li class="nav-item">
                    <a class="nav-link active" href="dashboard.html">
                        <i class="bi bi-speedometer2"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="usuarios/index.html">
                        <i class="bi bi-people"></i>Usuarios
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="clientes/index.html">
                        <i class="bi bi-person-badge"></i>Clientes
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="cuentas/index.html">
                        <i class="bi bi-credit-card"></i>Cuentas
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="prestamos/index.html">
                        <i class="bi bi-cash-coin"></i>Préstamos
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="transferencias/index.html">
                        <i class="bi bi-arrow-left-right"></i>Transferencias
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="parametros/tasas.html">
                        <i class="bi bi-gear"></i>Parámetros
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="permisos/index.html">
                        <i class="bi bi-shield-lock"></i>Permisos
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="reportes/index.html">
                        <i class="bi bi-file-earmark-bar-graph"></i>Reportes
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="configuracion/index.html">
                        <i class="bi bi-sliders"></i>Configuración
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="admin-main-content flex-fill">
            <div class="container-fluid">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-0">Dashboard</h2>
                        <p class="text-muted mb-0">Bienvenido al panel de administración</p>
                    </div>
                    <div>
                        <span class="text-muted" id="currentDate"></span>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row g-3 mb-4" id="statsContainer">
                    <div class="col-md-6 col-lg-3">
                        <div class="card stat-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Total Usuarios</p>
                                        <h3 class="mb-0" id="totalUsuarios">0</h3>
                                    </div>
                                    <div class="stat-card-icon primary">
                                        <i class="bi bi-people"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-3">
                        <div class="card stat-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Total Clientes</p>
                                        <h3 class="mb-0" id="totalClientes">0</h3>
                                    </div>
                                    <div class="stat-card-icon success">
                                        <i class="bi bi-person-badge"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-3">
                        <div class="card stat-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Total Cuentas</p>
                                        <h3 class="mb-0" id="totalCuentas">0</h3>
                                    </div>
                                    <div class="stat-card-icon warning">
                                        <i class="bi bi-credit-card"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-3">
                        <div class="card stat-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Préstamos Activos</p>
                                        <h3 class="mb-0" id="totalPrestamos">0</h3>
                                    </div>
                                    <div class="stat-card-icon danger">
                                        <i class="bi bi-cash-coin"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Cards -->
                <div class="row g-3">
                    <!-- Últimas Transacciones -->
                    <div class="col-lg-8">
                        <div class="card card-custom">
                            <div class="card-header">
                                <i class="bi bi-clock-history me-2"></i>Últimas Transacciones
                            </div>
                            <div class="card-body">
                                <div id="loadingTransacciones" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                                <div id="tablaTransacciones" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-custom mb-0">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Tipo</th>
                                                    <th>Monto</th>
                                                    <th>Cuenta</th>
                                                    <th>Fecha</th>
                                                    <th>Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="transaccionesBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actividad Reciente -->
                    <div class="col-lg-4">
                        <div class="card card-custom">
                            <div class="card-header">
                                <i class="bi bi-activity me-2"></i>Actividad Reciente
                            </div>
                            <div class="card-body">
                                <div class="list-group list-group-flush" id="actividadReciente">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../shared/js/api.js"></script>
    <script src="../shared/js/auth.js"></script>
    <script src="../shared/js/utils.js"></script>
    <script>
        // Verificar autenticación de admin
        verificarAutenticacion('admin');

        // Mostrar nombre del usuario
        const user = getUsuarioActual();
        if (user) {
            document.getElementById('adminName').textContent = user.username;
        }

        // Mostrar fecha actual
        document.getElementById('currentDate').textContent = formatearFecha(new Date());

        // Toggle sidebar en móvil
        document.getElementById('sidebarToggle')?.addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('show');
        });

        // Cargar estadísticas
        async function cargarEstadisticas() {
            try {
                // Cargar usuarios
                const usuarios = await getUsuarios();
                document.getElementById('totalUsuarios').textContent = usuarios.length || 0;

                // Cargar clientes
                const clientes = await getClientes();
                document.getElementById('totalClientes').textContent = clientes.length || 0;

                // Cargar cuentas
                const cuentas = await getCuentas();
                document.getElementById('totalCuentas').textContent = cuentas.length || 0;

                // Cargar préstamos
                const prestamos = await getPrestamos();
                const prestamosActivos = prestamos.filter(p => p.estado === 'aprobado' || p.estado === 'pendiente');
                document.getElementById('totalPrestamos').textContent = prestamosActivos.length || 0;

            } catch (error) {
                console.error('Error al cargar estadísticas:', error);
            }
        }

        // Cargar últimas transacciones
        async function cargarTransacciones() {
            try {
                const transacciones = await getTransacciones();
                const tbody = document.getElementById('transaccionesBody');
                
                document.getElementById('loadingTransacciones').style.display = 'none';
                document.getElementById('tablaTransacciones').style.display = 'block';
                
                if (transacciones.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay transacciones registradas</td></tr>';
                    return;
                }

                // Mostrar últimas 10
                const ultimas = transacciones.slice(0, 10);
                tbody.innerHTML = ultimas.map(t => {
                    const tipo = t.tipoTransaccion?.codigo || t.tipo_transaccion || 'N/A';
                    const tipoBadge = tipo === 'DEPOSITO' ? 'bg-success' : tipo === 'RETIRO' ? 'bg-danger' : 'bg-info';
                    const cuentaNum = t.cuentaOrigen?.numero_cuenta || t.cuentaDestino?.numero_cuenta || t.cuenta_origen || t.cuenta_destino || 'N/A';
                    
                    return `
                    <tr>
                        <td>#${t.id_transaccion || 'N/A'}</td>
                        <td>
                            <span class="badge ${tipoBadge}">
                                ${capitalizar(t.tipoTransaccion?.nombre || tipo)}
                            </span>
                        </td>
                        <td><strong>${formatearMoneda(t.monto || 0)}</strong></td>
                        <td>${cuentaNum}</td>
                        <td>${formatearFecha(t.fecha_transaccion || t.created_at)}</td>
                        <td><span class="badge bg-success">${capitalizar(t.estado || 'completada')}</span></td>
                    </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error al cargar transacciones:', error);
                document.getElementById('loadingTransacciones').innerHTML = 
                    '<div class="alert alert-danger">Error al cargar transacciones</div>';
            }
        }

        // Cargar actividad reciente
        async function cargarActividad() {
            const container = document.getElementById('actividadReciente');
            
            try {
                const transacciones = await getTransacciones();
                const ultimas5 = transacciones.slice(0, 5);
                
                if (ultimas5.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">No hay actividad reciente</p>';
                    return;
                }

                container.innerHTML = ultimas5.map(t => {
                    const tipo = t.tipoTransaccion?.codigo || t.tipo_transaccion || 'N/A';
                    const cuentaNum = t.cuentaOrigen?.numero_cuenta || t.cuentaDestino?.numero_cuenta || t.cuenta_origen || t.cuenta_destino || 'N/A';
                    const colorClase = tipo === 'DEPOSITO' ? 'text-success' : tipo === 'RETIRO' ? 'text-danger' : 'text-info';
                    
                    return `
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">${capitalizar(t.tipoTransaccion?.nombre || tipo)}</h6>
                                <small class="text-muted">Cuenta #${cuentaNum}</small>
                            </div>
                            <div class="text-end">
                                <strong class="${colorClase}">
                                    ${formatearMoneda(t.monto || 0)}
                                </strong>
                                <br>
                                <small class="text-muted">${formatearFecha(t.fecha_transaccion || t.created_at)}</small>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error al cargar actividad:', error);
                container.innerHTML = '<div class="alert alert-danger">Error al cargar actividad</div>';
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            cargarEstadisticas();
            cargarTransacciones();
            cargarActividad();
        });
    </script>
</body>
</html>
