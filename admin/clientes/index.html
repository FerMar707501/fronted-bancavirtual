<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes - Banco Virtual</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../../shared/css/global.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark admin-navbar fixed-top">
        <div class="container-fluid">
            <button class="btn btn-link text-white d-lg-none" id="sidebarToggle">
                <i class="bi bi-list fs-4"></i>
            </button>
            <a class="navbar-brand" href="../dashboard.html">
                <i class="bi bi-bank2 me-2"></i>Banco Virtual
            </a>
            <div class="ms-auto d-flex align-items-center">
                <span class="text-white me-3">
                    <i class="bi bi-person-circle me-1"></i>
                    <span id="adminName">Administrador</span>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="cerrarSesion()">
                    <i class="bi bi-box-arrow-right me-1"></i>Salir
                </button>
            </div>
        </div>
    </nav>

    <div class="d-flex" style="margin-top: 56px;">
        <!-- Sidebar -->
        <nav class="admin-sidebar" id="sidebar">
            <ul class="nav flex-column py-3">
                <li class="nav-item">
                    <a class="nav-link" href="../dashboard.html">
                        <i class="bi bi-speedometer2"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../usuarios/index.html">
                        <i class="bi bi-people"></i>Usuarios
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="index.html">
                        <i class="bi bi-person-badge"></i>Clientes
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../cuentas/index.html">
                        <i class="bi bi-credit-card"></i>Cuentas
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../prestamos/index.html">
                        <i class="bi bi-cash-coin"></i>Préstamos
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../transferencias/index.html">
                        <i class="bi bi-arrow-left-right"></i>Transferencias
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../configuracion/index.html">
                        <i class="bi bi-gear"></i>Configuración
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../permisos/index.html">
                        <i class="bi bi-shield-lock"></i>Permisos
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../reportes/general.html">
                        <i class="bi bi-file-earmark-bar-graph"></i>Reportes
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="admin-main-content flex-fill">
            <div class="container-fluid">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-0">Gestión de Clientes</h2>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item"><a href="../dashboard.html">Dashboard</a></li>
                                <li class="breadcrumb-item active">Clientes</li>
                            </ol>
                        </nav>
                    </div>
                    <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#modalCliente" onclick="abrirModalCrear()">
                        <i class="bi bi-plus-circle me-2"></i>Nuevo Cliente
                    </button>
                </div>

                <!-- Filtros -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="filtroNombre" placeholder="Buscar por nombre o documento...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filtroEstado">
                                    <option value="">Todos los estados</option>
                                    <option value="activo">Activo</option>
                                    <option value="inactivo">Inactivo</option>
                                    <option value="bloqueado">Bloqueado</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filtroKYC">
                                    <option value="">Todos los KYC</option>
                                    <option value="pendiente">Pendiente</option>
                                    <option value="aprobado">Aprobado</option>
                                    <option value="rechazado">Rechazado</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="cargarClientes()">
                                    <i class="bi bi-search me-1"></i>Buscar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Clientes -->
                <div class="card card-custom">
                    <div class="card-header">
                        <i class="bi bi-person-badge me-2"></i>Lista de Clientes
                    </div>
                    <div class="card-body">
                        <div id="loadingClientes" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2">Cargando clientes...</p>
                        </div>

                        <div id="tablaClientes" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Documento</th>
                                            <th>Nombre Completo</th>
                                            <th>Correo</th>
                                            <th>Teléfono</th>
                                            <th>KYC</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="clientesBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Crear/Editar Cliente -->
    <div class="modal fade" id="modalCliente" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #db8e5e; color: white;">
                    <h5 class="modal-title" id="modalClienteTitle">Nuevo Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCliente">
                        <input type="hidden" id="clienteId">
                        
                        <div class="row g-3">
                            <div class="col-md-12">
                                <h6 class="border-bottom pb-2">Información Personal</h6>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="dpi" class="form-label">DPI <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="dpi" required maxlength="13" placeholder="1234567890123">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="nit" class="form-label">NIT <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="nit" required placeholder="12345678">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="primer_nombre" class="form-label">Primer Nombre <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="primer_nombre" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="segundo_nombre" class="form-label">Segundo Nombre</label>
                                <input type="text" class="form-control" id="segundo_nombre">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="primer_apellido" class="form-label">Primer Apellido <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="primer_apellido" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="segundo_apellido" class="form-label">Segundo Apellido</label>
                                <input type="text" class="form-control" id="segundo_apellido">
                            </div>
                            
                            <div class="col-md-12 mt-3">
                                <h6 class="border-bottom pb-2">Contacto</h6>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="correo" class="form-label">Correo Electrónico <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="correo" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <input type="text" class="form-control" id="telefono" placeholder="5555-1234">
                            </div>
                            
                            <div class="col-md-12 mt-3">
                                <h6 class="border-bottom pb-2">Dirección</h6>
                            </div>
                            
                            <div class="col-md-12">
                                <label for="direccion" class="form-label">Dirección Completa <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="direccion" rows="2" required></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom" onclick="guardarCliente()">
                        <i class="bi bi-save me-1"></i>Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../shared/js/api.js"></script>
    <script src="../../shared/js/auth.js"></script>
    <script src="../../shared/js/utils.js"></script>
    <script>
        verificarAutenticacion('admin');

        const user = getUsuarioActual();
        if (user) {
            document.getElementById('adminName').textContent = user.username;
        }

        let modoEdicion = false;

        document.getElementById('sidebarToggle')?.addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('show');
        });

        async function cargarClientes() {
            try {
                document.getElementById('loadingClientes').style.display = 'block';
                document.getElementById('tablaClientes').style.display = 'none';

                const clientes = await getClientes();
                const tbody = document.getElementById('clientesBody');

                const filtroNombre = document.getElementById('filtroNombre').value.toLowerCase();
                const filtroEstado = document.getElementById('filtroEstado').value;
                const filtroKYC = document.getElementById('filtroKYC').value;

                let clientesFiltrados = clientes.filter(c => {
                    const nombreCompleto = `${c.primer_nombre} ${c.segundo_nombre || ''} ${c.primer_apellido} ${c.segundo_apellido || ''}`.toLowerCase();
                    const matchNombre = !filtroNombre || 
                        nombreCompleto.includes(filtroNombre) ||
                        (c.dpi && c.dpi.includes(filtroNombre)) ||
                        (c.nit && c.nit.includes(filtroNombre));
                    const matchEstado = !filtroEstado || c.estado_cliente === filtroEstado;
                    const matchKYC = !filtroKYC || c.estado_kyc === filtroKYC;
                    return matchNombre && matchEstado && matchKYC;
                });

                if (clientesFiltrados.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No se encontraron clientes</td></tr>';
                } else {
                    tbody.innerHTML = clientesFiltrados.map(c => {
                        const nombreCompleto = `${c.primer_nombre} ${c.segundo_nombre || ''} ${c.primer_apellido} ${c.segundo_apellido || ''}`.trim();
                        const telefonoPrincipal = c.telefonos && c.telefonos.length > 0 
                            ? c.telefonos.find(t => t.principal)?.numero_telefono || c.telefonos[0].numero_telefono
                            : 'N/A';
                        
                        return `
                        <tr>
                            <td><strong>#${c.id_cliente}</strong></td>
                            <td>${c.dpi || 'N/A'}</td>
                            <td>${nombreCompleto}</td>
                            <td>${c.correo}</td>
                            <td>${telefonoPrincipal}</td>
                            <td>
                                <span class="badge ${c.estado_kyc === 'aprobado' ? 'bg-success' : c.estado_kyc === 'rechazado' ? 'bg-danger' : 'bg-warning'}">
                                    ${capitalizar(c.estado_kyc || 'pendiente')}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${c.estado_cliente === 'activo' ? 'bg-success' : c.estado_cliente === 'bloqueado' ? 'bg-danger' : 'bg-secondary'}">
                                    ${capitalizar(c.estado_cliente)}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="verCliente(${c.id_cliente})" title="Ver detalle">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="editarCliente(${c.id_cliente})" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="cambiarEstado(${c.id_cliente}, '${c.estado_cliente}')" title="Cambiar estado">
                                        <i class="bi bi-toggle-on"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    }).join('');
                }

                document.getElementById('loadingClientes').style.display = 'none';
                document.getElementById('tablaClientes').style.display = 'block';

            } catch (error) {
                console.error('Error al cargar clientes:', error);
                document.getElementById('loadingClientes').innerHTML = 
                    `<div class="alert alert-danger">Error al cargar clientes: ${error.message}</div>`;
            }
        }

        function abrirModalCrear() {
            modoEdicion = false;
            document.getElementById('modalClienteTitle').textContent = 'Nuevo Cliente';
            document.getElementById('formCliente').reset();
            document.getElementById('clienteId').value = '';
        }

        async function editarCliente(id) {
            try {
                const cliente = await getCliente(id);
                
                modoEdicion = true;
                document.getElementById('modalClienteTitle').textContent = 'Editar Cliente';
                document.getElementById('clienteId').value = cliente.id_cliente;
                document.getElementById('dpi').value = cliente.dpi;
                document.getElementById('nit').value = cliente.nit;
                document.getElementById('primer_nombre').value = cliente.primer_nombre;
                document.getElementById('segundo_nombre').value = cliente.segundo_nombre || '';
                document.getElementById('primer_apellido').value = cliente.primer_apellido;
                document.getElementById('segundo_apellido').value = cliente.segundo_apellido || '';
                document.getElementById('correo').value = cliente.correo;
                document.getElementById('direccion').value = cliente.direccion || '';
                
                // Telefono principal
                if (cliente.telefonos && cliente.telefonos.length > 0) {
                    const telPrincipal = cliente.telefonos.find(t => t.principal) || cliente.telefonos[0];
                    document.getElementById('telefono').value = telPrincipal.numero_telefono;
                }
                
                new bootstrap.Modal(document.getElementById('modalCliente')).show();
            } catch (error) {
                alert('Error al cargar cliente: ' + error.message);
            }
        }

        async function guardarCliente() {
            try {
                const form = document.getElementById('formCliente');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const data = {
                    dpi: document.getElementById('dpi').value.trim(),
                    nit: document.getElementById('nit').value.trim(),
                    primer_nombre: document.getElementById('primer_nombre').value.trim(),
                    segundo_nombre: document.getElementById('segundo_nombre').value.trim(),
                    primer_apellido: document.getElementById('primer_apellido').value.trim(),
                    segundo_apellido: document.getElementById('segundo_apellido').value.trim(),
                    correo: document.getElementById('correo').value.trim(),
                    direccion: document.getElementById('direccion').value.trim()
                };

                // Agregar teléfono si existe
                const telefono = document.getElementById('telefono').value.trim();
                if (telefono && !modoEdicion) {
                    data.telefonos = [{
                        numero_telefono: telefono,
                        tipo: 'movil',
                        principal: true
                    }];
                }

                if (!modoEdicion) {
                    await crearCliente(data);
                    alert('✅ Cliente creado exitosamente');
                } else {
                    const id = document.getElementById('clienteId').value;
                    await actualizarCliente(id, data);
                    alert('✅ Cliente actualizado exitosamente');
                }

                bootstrap.Modal.getInstance(document.getElementById('modalCliente')).hide();
                cargarClientes();
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        }

        async function cambiarEstado(id, estadoActual) {
            const estados = ['activo', 'inactivo', 'bloqueado'];
            const estadoIndex = estados.indexOf(estadoActual);
            const nuevoEstado = estados[(estadoIndex + 1) % estados.length];
            
            if (!confirm(`¿Cambiar estado a "${nuevoEstado}"?`)) return;

            try {
                await apiCall(`/clientes/${id}/estado`, 'PATCH', { estado: nuevoEstado });
                alert('✅ Estado actualizado');
                cargarClientes();
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        }

        function verCliente(id) {
            window.location.href = `ver.html?id=${id}`;
        }

        document.addEventListener('DOMContentLoaded', cargarClientes);
    </script>
</body>
</html>
